

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>trikit.estimators.mack &mdash; trikit 0.3.2 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> trikit
          

          
          </a>

          
            
            
              <div class="version">
                0.3
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">Project Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../triangle.html">Triangles</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../estimators.html">Estimators</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasets.html">Sample Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lrdb.html">CAS Loss Reserving Database</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/correlated.html">Correlated Reserve Indications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/smoothing.html">Smoothing Loss Development Patterns</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">trikit</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>trikit.estimators.mack</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for trikit.estimators.mack</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">_MackChainLadder implementation.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">special</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span><span class="p">,</span> <span class="n">lognorm</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">root</span>
<span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">BaseRangeEstimator</span><span class="p">,</span> <span class="n">BaseRangeEstimatorResult</span>



<div class="viewcode-block" id="MackChainLadder"><a class="viewcode-back" href="../../../trikit.estimators.html#trikit.estimators.mack.MackChainLadder">[docs]</a><span class="k">class</span> <span class="nc">MackChainLadder</span><span class="p">(</span><span class="n">BaseRangeEstimator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Mack Chain Ladder estimator. The predicition variance is comprised</span>
<span class="sd">    of the estimation variance and the process variance. Estimation variance</span>
<span class="sd">    arises from the inability to accurately define the distribution from which</span>
<span class="sd">    past events have been generated. Process variance arises from the</span>
<span class="sd">    inability to accurately predict which single outcome from the distribution</span>
<span class="sd">    will occur at a given time. The predicition error is defined as the</span>
<span class="sd">    standard deviation of the forecast.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cumtri: triangle._CumTriangle</span>
<span class="sd">        A cumulative.CumTriangle instance</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    1. Mack, Thomas (1993) *Measuring the Variability of Chain Ladder Reserve</span>
<span class="sd">       Estimates*, 1993 CAS Prize Paper Competition on Variability of Loss Reserves.</span>

<span class="sd">    2. Mack, Thomas, (1993), *Distribution-Free Calculation of the Standard Error</span>
<span class="sd">       of Chain Ladder Reserve Estimates*, ASTIN Bulletin 23, no. 2:213-225.</span>

<span class="sd">    3. Mack, Thomas, (1999), *The Standard Error of Chain Ladder Reserve Estimates:</span>
<span class="sd">       Recursive Calculation and Inclusion of a Tail Factor*, ASTIN Bulletin 29,</span>
<span class="sd">       no. 2:361-366.</span>

<span class="sd">    4. England, P., and R. Verrall, (2002), *Stochastic Claims Reserving in General Insurance*, British Actuarial Journal 8(3): 443-518.</span>

<span class="sd">    5. Murphy, Daniel, (2007), *Chain Ladder Reserve Risk Estimators*, CAS E-Forum, Summer 2007.</span>

<span class="sd">    6. Carrato, A., McGuire, G. and Scarth, R. 2016. *A Practitioner&#39;s</span>
<span class="sd">       Introduction to Stochastic Reserving*, The Institute and Faculty of</span>
<span class="sd">       Actuaries. 2016.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cumtri</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">cumtri</span><span class="p">)</span>

        <span class="c1"># Properties.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mod_a2aind</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mod_tri</span> <span class="o">=</span> <span class="kc">None</span>



    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="s2">&quot;lognorm&quot;</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">75</span><span class="p">,</span> <span class="o">.</span><span class="mi">95</span><span class="p">],</span> <span class="n">two_sided</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a summary of ultimate and reserve estimates resulting from</span>
<span class="sd">        the application of the Mack Chain Ladder over self.tri. Summary</span>
<span class="sd">        DataFrame is comprised of origin year, maturity of origin year, loss</span>
<span class="sd">        amount at latest evaluation, cumulative loss development factors,</span>
<span class="sd">        projected ultimates and the reserve estimate, by origin year and in</span>
<span class="sd">        aggregate.</span>

<span class="sd">        ### TODO ###</span>
<span class="sd">        Allow for tail factor other than 1.0.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha: {0, 1, 2}</span>
<span class="sd">            * ``0``: Straight average of observed individual link ratios.</span>
<span class="sd">            * ``1``: Historical Chain Ladder age-to-age factors.</span>
<span class="sd">            * ``2``: Regression of $C_{k+1}$ on $C_{k}$ with 0 intercept.</span>

<span class="sd">        tail: float</span>
<span class="sd">            Tail factor. Currently not implemented. Will be available in</span>
<span class="sd">            a future release.</span>

<span class="sd">        dist: {&quot;norm&quot;, &quot;lognorm&quot;}</span>
<span class="sd">            The distribution function chosen to approximate the true</span>
<span class="sd">            distribution of reserves by origin period. In Mack[1], if the</span>
<span class="sd">            volume of outstanding claims is large enough, due to the central</span>
<span class="sd">            limit theorem, we can assume that the distribution function is</span>
<span class="sd">            Normal with expected value equal to the point estimate given by</span>
<span class="sd">            $R_{i}$ and standard deviation equal to the standard error of</span>
<span class="sd">            $R_{i}$, $s.e.(R_{i})$. It is also noted that if the true</span>
<span class="sd">            distribution of reserves is skewed, the Normal may not serve as a</span>
<span class="sd">            good approximation, and it may be preferrable to opt for</span>
<span class="sd">            the Log-normal distribution.</span>

<span class="sd">            * If ``dist=&quot;norm&quot;``, the Normal distribution will be used to</span>
<span class="sd">            estimate reserve quantiles.</span>
<span class="sd">            * If ``dist=&quot;lognorm&quot;``, the Log-normal distribution will be used</span>
<span class="sd">            to estimate reserve quantiles.</span>

<span class="sd">        q: array_like of float</span>
<span class="sd">            Quantile or sequence of quantiles to compute, which must be</span>
<span class="sd">            between 0 and 1 inclusive.</span>

<span class="sd">        two_sided: bool</span>
<span class="sd">            Whether the two_sided interval should be included in summary</span>
<span class="sd">            output. For example, if ``two_sided==True`` and ``q=.95``, then</span>
<span class="sd">            the 2.5th and 97.5th quantiles of the estimated reserve</span>
<span class="sd">            distribution will be returned [(1 - .95) / 2, (1 + .95) / 2]. When</span>
<span class="sd">            False, only the specified quantile(s) will be computed. Defaults</span>
<span class="sd">            to False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        MackChainLadderResult</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ldfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ldfs</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="n">cldfs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cldfs</span><span class="p">(</span><span class="n">ldfs</span><span class="o">=</span><span class="n">ldfs</span><span class="p">)</span>
        <span class="n">maturity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">maturity</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">str</span><span class="p">)</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">latest_by_origin</span>
        <span class="n">ultimates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ultimates</span><span class="p">(</span><span class="n">cldfs</span><span class="o">=</span><span class="n">cldfs</span><span class="p">)</span>
        <span class="n">reserves</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserves</span><span class="p">(</span><span class="n">ultimates</span><span class="o">=</span><span class="n">ultimates</span><span class="p">)</span>
        <span class="n">devpvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_devp_variance</span><span class="p">(</span><span class="n">ldfs</span><span class="o">=</span><span class="n">ldfs</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">ldfvar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ldf_variance</span><span class="p">(</span><span class="n">devpvar</span><span class="o">=</span><span class="n">devpvar</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
        <span class="n">proc_error</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_error</span><span class="p">(</span><span class="n">ldfs</span><span class="o">=</span><span class="n">ldfs</span><span class="p">,</span> <span class="n">devpvar</span><span class="o">=</span><span class="n">devpvar</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;process_error&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span>
            <span class="p">)</span>
        <span class="n">param_error</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parameter_error</span><span class="p">(</span><span class="n">ldfs</span><span class="o">=</span><span class="n">ldfs</span><span class="p">,</span> <span class="n">ldfvar</span><span class="o">=</span><span class="n">ldfvar</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;parameter_error&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span>
            <span class="p">)</span>
        <span class="n">mse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mean_squared_error</span><span class="p">(</span>
            <span class="n">process_error</span><span class="o">=</span><span class="n">proc_error</span><span class="p">,</span> <span class="n">parameter_error</span><span class="o">=</span><span class="n">param_error</span>
            <span class="p">)</span>
        <span class="n">std_error</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;std_error&quot;</span><span class="p">)</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">std_error</span> <span class="o">/</span> <span class="n">reserves</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;cv&quot;</span><span class="p">)</span>
        <span class="n">trisqrd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trisqrd</span><span class="p">(</span><span class="n">ldfs</span><span class="o">=</span><span class="n">ldfs</span><span class="p">)</span>

        <span class="n">dfmatur</span> <span class="o">=</span> <span class="n">maturity</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;origin&quot;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dfcldfs</span> <span class="o">=</span> <span class="n">cldfs</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;maturity&quot;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dfcldfs</span><span class="p">[</span><span class="s2">&quot;maturity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcldfs</span><span class="p">[</span><span class="s2">&quot;maturity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">dfcldfs</span><span class="p">[</span><span class="s2">&quot;emergence&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">dfcldfs</span><span class="p">[</span><span class="s2">&quot;cldf&quot;</span><span class="p">]</span>
        <span class="n">dfsumm</span> <span class="o">=</span> <span class="n">dfmatur</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfcldfs</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;maturity&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span><span class="p">)</span>
        <span class="n">dfsumm</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">dflatest</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;latest_by_origin&quot;</span><span class="p">:</span> <span class="s2">&quot;latest&quot;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dfsumm</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span> <span class="n">df1</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df2</span><span class="p">),</span>
            <span class="p">(</span><span class="n">dflatest</span><span class="p">,</span> <span class="n">ultimates</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(),</span> <span class="n">reserves</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(),</span> <span class="n">std_error</span><span class="o">.</span><span class="n">to_frame</span><span class="p">(),</span> <span class="n">cv</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()),</span>
            <span class="n">dfsumm</span>
            <span class="p">)</span>

        <span class="c1"># Add total index and set to NaN fields that shouldn&#39;t be aggregated.</span>
        <span class="n">dfsumm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfsumm</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">dfsumm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="s2">&quot;maturity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">dfsumm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;cldf&quot;</span><span class="p">,</span> <span class="s2">&quot;emergence&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

        <span class="c1"># Create latest and trisqrd reference using 1-based indexing.</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">latest</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">latest</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latest</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">latest</span><span class="o">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">latest</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">trisqrd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trisqrd</span><span class="p">(</span><span class="n">ldfs</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;ultimate&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">trisqrd</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">trisqrd</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">trisqrd</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">trisqrd</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Compute mse for aggregate reserve.</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">devp</span><span class="o">.</span><span class="n">size</span>
        <span class="n">mse_total</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">dfsumm</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="n">quotient</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">devpvar</span> <span class="o">/</span> <span class="n">ldfs</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">quotient</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">quotient</span><span class="o">.</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mse_total</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">start</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">mse_ii</span><span class="p">,</span> <span class="n">ult_ii</span> <span class="o">=</span> <span class="n">mse</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">ultimates</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">ults_sum</span> <span class="o">=</span> <span class="n">ultimates</span><span class="p">[</span><span class="n">ultimates</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">rh_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                <span class="n">quotient</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">trisqrd</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mm</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">jj</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">indx</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="n">mse_total</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">=</span> <span class="n">mse_ii</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">ult_ii</span> <span class="o">*</span> <span class="n">ults_sum</span> <span class="o">*</span> <span class="n">rh_sum</span>

        <span class="c1"># Reset trisqrd columns and index back to original values.</span>
        <span class="n">trisqrd</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">trisqrd</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">index</span>
        <span class="n">dfsumm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="s2">&quot;std_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse_total</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">dfsumm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="s2">&quot;cv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfsumm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="s2">&quot;std_error&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dfsumm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="s2">&quot;reserve&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">dist</span> <span class="o">==</span> <span class="s2">&quot;norm&quot;</span><span class="p">:</span>
            <span class="n">std_params</span><span class="p">,</span> <span class="n">mean_params</span> <span class="o">=</span> <span class="n">dfsumm</span><span class="p">[</span><span class="s2">&quot;std_error&quot;</span><span class="p">],</span> <span class="n">dfsumm</span><span class="p">[</span><span class="s2">&quot;reserve&quot;</span><span class="p">]</span>
            <span class="n">rv_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">jj</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mean_params</span><span class="p">,</span> <span class="n">std_params</span><span class="p">)]</span>

        <span class="k">elif</span> <span class="n">dist</span> <span class="o">==</span> <span class="s2">&quot;lognorm&quot;</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
                <span class="n">std_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">dfsumm</span><span class="p">[</span><span class="s2">&quot;std_error&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">dfsumm</span><span class="p">[</span><span class="s2">&quot;reserve&quot;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">mean_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dfsumm</span><span class="p">[</span><span class="s2">&quot;reserve&quot;</span><span class="p">]),</span> <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-</span> <span class="o">.</span><span class="mi">50</span> <span class="o">*</span> <span class="n">std_params</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">rv_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">lognorm</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ii</span><span class="p">),</span> <span class="n">s</span><span class="o">=</span><span class="n">jj</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mean_params</span><span class="p">,</span> <span class="n">std_params</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;dist must be one of {{&#39;norm&#39;, &#39;lognorm&#39;}}, not `</span><span class="si">{}</span><span class="s2">`.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dist</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="n">rvs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">rv_list</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">dfsumm</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">qtls</span><span class="p">,</span> <span class="n">qtlhdrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qtls_formatter</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">two_sided</span><span class="o">=</span><span class="n">two_sided</span><span class="p">)</span>

        <span class="c1"># Populate qtlhdrs columns with estimated quantile estimates.</span>
        <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">qtls</span><span class="p">,</span> <span class="n">qtlhdrs</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="n">rvs</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                    <span class="n">dfsumm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">origin</span><span class="p">,</span> <span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">rvs</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>

        <span class="n">dfsumm</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="p">[</span><span class="s2">&quot;cv&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">qtlhdrs</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

        <span class="n">mcl_result</span> <span class="o">=</span> <span class="n">MackChainLadderResult</span><span class="p">(</span>
            <span class="n">summary</span><span class="o">=</span><span class="n">dfsumm</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="p">,</span> <span class="n">ldfs</span><span class="o">=</span><span class="n">ldfs</span><span class="p">,</span> <span class="n">trisqrd</span><span class="o">=</span><span class="n">trisqrd</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
            <span class="n">process_error</span><span class="o">=</span><span class="n">proc_error</span><span class="p">,</span> <span class="n">parameter_error</span><span class="o">=</span><span class="n">param_error</span><span class="p">,</span> <span class="n">devpvar</span><span class="o">=</span><span class="n">devpvar</span><span class="p">,</span>
            <span class="n">ldfvar</span><span class="o">=</span><span class="n">ldfvar</span><span class="p">,</span> <span class="n">rvs</span><span class="o">=</span><span class="n">rvs</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="n">tail</span>
            <span class="p">)</span>

        <span class="k">return</span><span class="p">(</span><span class="n">mcl_result</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mod_tri</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return modified triangle-shaped DataFrame with same indices as ``self.tri.a2a``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mod_tri</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mod_tri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">latest</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">r_indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">latest</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="s2">&quot;origin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">c_indx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">latest</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="s2">&quot;dev&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mod_tri</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">r_indx</span><span class="p">,</span> <span class="n">c_indx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mod_tri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mod_tri</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mod_tri</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mod_a2aind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return self.tri.a2aind with lower right 0s replaced with NaN.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mod_a2aind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mod_a2aind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">a2aind</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mod_a2aind</span><span class="p">)</span>


<div class="viewcode-block" id="MackChainLadder._ldfs"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadder._ldfs">[docs]</a>    <span class="k">def</span> <span class="nf">_ldfs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute Mack loss development factors.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        alpha: {0, 1, 2}</span>
<span class="sd">            * 0: Straight average of observed individual link ratios.</span>
<span class="sd">            * 1: Historical Chain Ladder age-to-age factors.</span>
<span class="sd">            * 2: Regression of :math:`C_{k+1}` on :math:`C_{k}` with 0 intercept.</span>

<span class="sd">        tail: float</span>
<span class="sd">            Tail factor. At present, must be 1.0. This may change in a future release.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">C</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_tri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_a2aind</span>
        <span class="n">ldfs</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">a2a</span> <span class="o">*</span> <span class="n">w</span> <span class="o">*</span> <span class="n">C</span><span class="o">**</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="n">C</span><span class="o">**</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">increment</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">ldfs</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">ldfs</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ldfs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ldfs</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="n">increment</span><span class="p">]</span> <span class="o">=</span> <span class="n">tail</span>
        <span class="k">return</span><span class="p">(</span><span class="n">ldfs</span><span class="p">)</span></div>


<div class="viewcode-block" id="MackChainLadder._ldf_variance"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadder._ldf_variance">[docs]</a>    <span class="k">def</span> <span class="nf">_ldf_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">devpvar</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the variance of a given development period&#39;s link ratios</span>
<span class="sd">        w.r.t. selected ldfs.</span>

<span class="sd">        devpvar: pd.Series</span>
<span class="sd">            The development period variance, usually represented as</span>
<span class="sd">            :math:`\\hat{\\sigma}^{2}_{k}` in the literature. For a triangle with</span>
<span class="sd">            n development periods, devpvar will contain n-1 elements.</span>

<span class="sd">        alpha: {0, 1, 2}</span>
<span class="sd">            * 0: Straight average of observed individual link ratios.</span>
<span class="sd">            * 1: Historical Chain Ladder age-to-age factors.</span>
<span class="sd">            * 2: Regression of :math`C_{k+1}` on :math: `C_{k}` with 0 intercept.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ldfvar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">devpvar</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ldfvar&quot;</span><span class="p">)</span>
        <span class="n">C</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_tri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_a2aind</span>
        <span class="k">for</span> <span class="n">devp</span> <span class="ow">in</span> <span class="n">w</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">ldfvar</span><span class="p">[</span><span class="n">devp</span><span class="p">]</span> <span class="o">=</span> <span class="n">devpvar</span><span class="p">[</span><span class="n">devp</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">devp</span><span class="p">]</span> <span class="o">*</span> <span class="n">C</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">devp</span><span class="p">]</span><span class="o">**</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">return</span><span class="p">(</span><span class="n">ldfvar</span><span class="p">)</span></div>


<div class="viewcode-block" id="MackChainLadder._devp_variance"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadder._devp_variance">[docs]</a>    <span class="k">def</span> <span class="nf">_devp_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ldfs</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the development period variance, usually represented as</span>
<span class="sd">        :math:`\\hat{\\sigma}^{2}_{k}` in the literature. For a triangle with</span>
<span class="sd">        n development periods, result will contain n-1 elements.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ldfs: pd.Series</span>
<span class="sd">            Selected ldfs, typically the output of calling ``self._ldfs``, or a series</span>
<span class="sd">            of values indexed by development period.</span>

<span class="sd">         alpha: {0, 1, 2}</span>
<span class="sd">            * 0: Straight average of observed individual link ratios.</span>
<span class="sd">            * 1: Historical Chain Ladder age-to-age factors.</span>
<span class="sd">            * 2: Regression of :math:`C_{k+1}` on :math:`C_{k}` with 0 intercept.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">devpvar</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">ldfs</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;devpvar&quot;</span><span class="p">)</span>
        <span class="n">C</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_tri</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mod_a2aind</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">a2a</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">origins</span><span class="o">.</span><span class="n">size</span>
        <span class="k">for</span> <span class="n">indx</span><span class="p">,</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">devp</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]):</span>
            <span class="n">devpvar</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span><span class="o">**</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">F</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">-</span> <span class="n">ldfs</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="n">indx</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Calculate development period variance for period n-1.</span>
        <span class="n">devpvar</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span>
            <span class="n">devpvar</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">devpvar</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">devpvar</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">devpvar</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]])</span>
            <span class="p">))</span>
        <span class="k">return</span><span class="p">(</span><span class="n">devpvar</span><span class="p">)</span></div>


<div class="viewcode-block" id="MackChainLadder._process_error"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadder._process_error">[docs]</a>    <span class="k">def</span> <span class="nf">_process_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ldfs</span><span class="p">,</span> <span class="n">devpvar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a triangle-shaped DataFrame containing elementwise process</span>
<span class="sd">        error. To obtain the process error for a given origin period,</span>
<span class="sd">        cells are aggregated across columns.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ldfs: pd.Series</span>
<span class="sd">            Selected ldfs, typically the output of calling ``self._ldfs``,</span>
<span class="sd">            or a series of values indexed by development period.</span>

<span class="sd">        devpvar: pd.Series</span>
<span class="sd">            The development period variance, usually represented as</span>
<span class="sd">            :math:`\\hat{\\sigma}^{2}_{k}` in the literature. For a triangle with</span>
<span class="sd">            n development periods, devpvar will contain n-1 elements.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create latest reference using 1-based indexing.</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">latest</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">latest</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latest</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">latest</span><span class="o">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">latest</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create DataFrame to hold cellwise process error.</span>
        <span class="n">dfpe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">dfpe</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dfpe</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dfpe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dfpe</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Bind reference to squared triangle.</span>
        <span class="n">trisqrd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trisqrd</span><span class="p">(</span><span class="n">ldfs</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;ultimate&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">trisqrd</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">trisqrd</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">trisqrd</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">trisqrd</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">devp</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># `ii` iterates by origin, `kk` by development period.</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">dfpe</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">latest_devp</span> <span class="o">=</span> <span class="n">latest</span><span class="p">[</span><span class="n">latest</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ii</span><span class="p">][</span><span class="s2">&quot;dev&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">latest_cum</span> <span class="o">=</span> <span class="n">trisqrd</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">latest_devp</span><span class="p">]</span>
            <span class="n">kk0</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">ii</span>
            <span class="n">dfpe</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">kk0</span><span class="p">]</span> <span class="o">=</span> <span class="n">latest_cum</span> <span class="o">*</span> <span class="n">devpvar</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">kk0</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kk0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">term0</span> <span class="o">=</span> <span class="p">(</span><span class="n">ldfs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">kk</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dfpe</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">kk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">term1</span> <span class="o">=</span> <span class="n">trisqrd</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">kk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">devpvar</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">kk</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                <span class="n">dfpe</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">term0</span> <span class="o">+</span> <span class="n">term1</span>

        <span class="c1"># Re-index dfpe to match self.tri.</span>
        <span class="n">dfpe</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">dfpe</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">index</span>
        <span class="k">return</span><span class="p">(</span><span class="n">dfpe</span><span class="p">)</span></div>


<div class="viewcode-block" id="MackChainLadder._parameter_error"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadder._parameter_error">[docs]</a>    <span class="k">def</span> <span class="nf">_parameter_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ldfs</span><span class="p">,</span> <span class="n">ldfvar</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a triangle-shaped DataFrame containing elementwise parameter</span>
<span class="sd">        error. To obtain the parameter error for a given origin period,</span>
<span class="sd">        cells are aggregated across columns.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ldfs: pd.Series</span>
<span class="sd">            Selected ldfs, typically the output of calling ``self._ldfs``,</span>
<span class="sd">            or a series of values indexed by development period.</span>

<span class="sd">        ldfvar: pd.Series</span>
<span class="sd">            Link ratio variance. For a triangle with n development</span>
<span class="sd">            periods, ldfvar will contain n-1 elements.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create latest reference using 1-based indexing.</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">latest</span><span class="o">.</span><span class="n">sort_index</span><span class="p">()</span>
        <span class="n">latest</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">latest</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">latest</span><span class="o">.</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">latest</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create DataFrame to hold cellwise parameter error.</span>
        <span class="n">dfpe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">dfpe</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dfpe</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dfpe</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dfpe</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Bind reference to squared triangle.</span>
        <span class="n">trisqrd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trisqrd</span><span class="p">(</span><span class="n">ldfs</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;ultimate&quot;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">trisqrd</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">trisqrd</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">trisqrd</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">trisqrd</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">devp</span><span class="o">.</span><span class="n">size</span>

        <span class="c1"># `ii` iterates by origin, `kk` by development period.</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">dfpe</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">latest_devp</span> <span class="o">=</span> <span class="n">latest</span><span class="p">[</span><span class="n">latest</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ii</span><span class="p">][</span><span class="s2">&quot;dev&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="n">latest_cum</span> <span class="o">=</span> <span class="n">trisqrd</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">latest_devp</span><span class="p">]</span>
            <span class="n">kk0</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">ii</span>
            <span class="n">dfpe</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">kk0</span><span class="p">]</span> <span class="o">=</span> <span class="n">latest_cum</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ldfvar</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">kk0</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">kk0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">term0</span> <span class="o">=</span> <span class="p">(</span><span class="n">ldfs</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">kk</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dfpe</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">kk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">term1</span> <span class="o">=</span> <span class="p">(</span><span class="n">trisqrd</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">kk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">ldfvar</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">kk</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span>
                <span class="n">term2</span> <span class="o">=</span> <span class="n">ldfvar</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">kk</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">dfpe</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">kk</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">dfpe</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span> <span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">term0</span> <span class="o">+</span> <span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span>

        <span class="c1"># Re-index dfpe to match self.tri.</span>
        <span class="n">dfpe</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">dfpe</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">index</span>
        <span class="k">return</span><span class="p">(</span><span class="n">dfpe</span><span class="p">)</span></div>


<div class="viewcode-block" id="MackChainLadder._mean_squared_error"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadder._mean_squared_error">[docs]</a>    <span class="k">def</span> <span class="nf">_mean_squared_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process_error</span><span class="p">,</span> <span class="n">parameter_error</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the mean squared error of reserve estimates for each</span>
<span class="sd">        origin period. The standard error for each origin period</span>
<span class="sd">        is the square root of the mean squared error.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        process_error: pd.Series</span>
<span class="sd">            Reserve estimate process error indexed by origin. Represents the</span>
<span class="sd">            risk associated with the projection of future contingencies that</span>
<span class="sd">            are inherently variable, even if the parameters are known</span>
<span class="sd">            with certainty.</span>

<span class="sd">        parameter_error: pd.Series</span>
<span class="sd">            Reserve estimate parameter error indexed by origin. Represents</span>
<span class="sd">            the risk that the parameters used in the methods or models are not</span>
<span class="sd">            representative of future outcomes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.Series</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">process_error</span> <span class="o">+</span> <span class="n">parameter_error</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">))</span></div></div>



<div class="viewcode-block" id="MackChainLadderResult"><a class="viewcode-back" href="../../../trikit.estimators.html#trikit.estimators.mack.MackChainLadderResult">[docs]</a><span class="k">class</span> <span class="nc">MackChainLadderResult</span><span class="p">(</span><span class="n">BaseRangeEstimatorResult</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container class for ``MackChainLadder`` output.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    summary: pd.DataFrame</span>
<span class="sd">        ``MackChainLadder`` summary.</span>

<span class="sd">    tri: trikit.triangle.CumTriangle</span>
<span class="sd">        A cumulative triangle instance.</span>

<span class="sd">    alpha: int</span>
<span class="sd">        MackChainLadder alpha parameter.</span>

<span class="sd">    tail: float</span>
<span class="sd">        Tail factor.</span>

<span class="sd">    ldfs: pd.Series</span>
<span class="sd">        Loss development factors.</span>

<span class="sd">    trisqrd: pd.DataFrame</span>
<span class="sd">        Projected claims growth for each future development period.</span>

<span class="sd">    dist: str</span>
<span class="sd">        The distribution function chosen to approximate the true distribution of</span>
<span class="sd">        reserves by origin period. Wither &quot;norm&quot; or &quot;lognorm&quot;.</span>

<span class="sd">    process_error: pd.Series</span>
<span class="sd">        Reserve estimate process error indexed by origin. Represents the</span>
<span class="sd">        risk associated with the projection of future contingencies that</span>
<span class="sd">        are inherently variable, even if parameters are known with certainty.</span>

<span class="sd">    parameter_error: pd.Series</span>
<span class="sd">        Reserve estimate parameter error indexed by origin. Represents</span>
<span class="sd">        the risk that the parameters used in the methods or models are not</span>
<span class="sd">        representative of future outcomes.</span>

<span class="sd">    devpvar: pd.Series</span>
<span class="sd">        The development period variance, usually represented as</span>
<span class="sd">        :math:`\\hat{\\sigma}^{2}_{k}` in the literature. For a triangle having</span>
<span class="sd">        n development periods, ``devpvar`` will contain n-1</span>
<span class="sd">        elements.</span>

<span class="sd">    ldfvar: pd.Series</span>
<span class="sd">        Variance of age-to-age factors. Required for Murphy&#39;s recursive</span>
<span class="sd">        estimator of parameter risk. For a triangle having n</span>
<span class="sd">        development periods, ``ldfvar`` will contain n-1 elements.</span>

<span class="sd">    rvs: pd.Series</span>
<span class="sd">        Series indexed by origin containing Scipy frozen random variable</span>
<span class="sd">        with parameters mu and sigma having distribution specified by</span>
<span class="sd">        ``dist``.</span>

<span class="sd">    kwargs: dict</span>
<span class="sd">        Additional parameters originally passed into ``MackChainLadder``&#39;s</span>
<span class="sd">        ``__call__`` method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary</span><span class="p">,</span> <span class="n">tri</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">tail</span><span class="p">,</span> <span class="n">ldfs</span><span class="p">,</span> <span class="n">trisqrd</span><span class="p">,</span> <span class="n">dist</span><span class="p">,</span> <span class="n">process_error</span><span class="p">,</span>
                 <span class="n">parameter_error</span><span class="p">,</span> <span class="n">devpvar</span><span class="p">,</span> <span class="n">ldfvar</span><span class="p">,</span> <span class="n">rvs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">summary</span><span class="o">=</span><span class="n">summary</span><span class="p">,</span> <span class="n">tri</span><span class="o">=</span><span class="n">tri</span><span class="p">,</span> <span class="n">ldfs</span><span class="o">=</span><span class="n">ldfs</span><span class="p">,</span> <span class="n">tail</span><span class="o">=</span><span class="n">tail</span><span class="p">,</span> <span class="n">trisqrd</span><span class="o">=</span><span class="n">trisqrd</span><span class="p">,</span>
                         <span class="n">process_error</span><span class="o">=</span><span class="n">process_error</span><span class="p">,</span> <span class="n">parameter_error</span><span class="o">=</span><span class="n">parameter_error</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dist</span> <span class="o">=</span> <span class="n">dist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devpvar</span> <span class="o">=</span> <span class="n">devpvar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ldfvar</span> <span class="o">=</span> <span class="n">ldfvar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rvs</span> <span class="o">=</span> <span class="n">rvs</span>

        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kk</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">kk</span><span class="p">])</span>

        <span class="c1"># Add formats for method-specific columns.</span>
        <span class="n">mack_summ_hdrs</span> <span class="o">=</span> <span class="p">{</span><span class="n">ii</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:,.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">ii</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_summspecs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mack_summ_hdrs</span><span class="p">)</span>


<div class="viewcode-block" id="MackChainLadderResult._residuals_by_devp"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadderResult._residuals_by_devp">[docs]</a>    <span class="k">def</span> <span class="nf">_residuals_by_devp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate standardized residuals by development period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">devpx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">devp</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">devpy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">devpx</span><span class="p">,</span> <span class="n">shift</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">devpx</span><span class="p">,</span> <span class="n">devpy</span><span class="p">))[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">resids_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">xy</span><span class="p">:</span>
            <span class="c1"># Multiply triangle values at development period x by ldf at development</span>
            <span class="c1"># period x, then compute difference against triangle values at development</span>
            <span class="c1"># period y.</span>
            <span class="n">yact_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="p">[</span><span class="n">y</span><span class="p">]</span>
            <span class="n">comp_indices</span> <span class="o">=</span> <span class="n">yact_init</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">yact_init</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">comp_indices</span><span class="o">.</span><span class="n">size</span>
            <span class="n">yact</span> <span class="o">=</span> <span class="n">yact_init</span><span class="p">[</span><span class="n">comp_indices</span><span class="p">]</span>
            <span class="n">yhat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comp_indices</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldfs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">dfresid</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">yhat</span> <span class="o">-</span> <span class="n">yact</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;residuals&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
            <span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;std_residuals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">))</span>
            <span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">resids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfresid</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">resids_list</span><span class="p">))</span></div>


<div class="viewcode-block" id="MackChainLadderResult._residuals_by_origin"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadderResult._residuals_by_origin">[docs]</a>    <span class="k">def</span> <span class="nf">_residuals_by_origin</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate standardized residuals by origin period.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">resids_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">origins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">dfresid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="n">origin</span><span class="p">:</span> <span class="s2">&quot;yact&quot;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;yhat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;yact&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ldfs</span><span class="p">)</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dfresid</span> <span class="o">=</span> <span class="n">dfresid</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;any&quot;</span><span class="p">)</span>
            <span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;yhat&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;yact&quot;</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">dfresid</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;std_residuals&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;residuals&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;sigma&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">))</span>
            <span class="n">dfresid</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span>
            <span class="n">resids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfresid</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">resids_list</span><span class="p">))</span></div>


<div class="viewcode-block" id="MackChainLadderResult._spearman_corr_coeffs"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadderResult._spearman_corr_coeffs">[docs]</a>    <span class="k">def</span> <span class="nf">_spearman_corr_coeffs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute the Spearman correlation coefficients for each pair of equal</span>
<span class="sd">        sized columns from ``self.tri._ranked_a2a``.</span>

<span class="sd">        For adjacent columns, a Spearman coefficient close to 0 indicates that</span>
<span class="sd">        the development factors between development years k - 1 and k and</span>
<span class="sd">        those between developmenr years k and k+1 are uncorrelated. Any</span>
<span class="sd">        other value of :math:`T_{k}` indicates that the factors are positively or</span>
<span class="sd">        negatively correlated.</span>

<span class="sd">        In the resulting DataFrame, columns are defined as:</span>

<span class="sd">            - k:</span>
<span class="sd">                An enumeration of the target development period.</span>

<span class="sd">            - w:</span>
<span class="sd">                Quanity used to weight the Spearman coefficient, specified</span>
<span class="sd">                as n - k - 1, where n is the number of origin periods</span>
<span class="sd">                in the triangle.</span>

<span class="sd">            - T_k:</span>
<span class="sd">                Spearman correlation coefficient. Defined as :math:`T_{k} = 1 - 6 \\sum_{i=1}^{n-k}`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>

<span class="sd">        References</span>
<span class="sd">        ----------</span>
<span class="sd">        1. Mack, Thomas (1993) *Measuring the Variability of Chain Ladder Reserve</span>
<span class="sd">        Estimates*, 1993 CAS Prize Paper Competition on Variability of Loss Reserves.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dfranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">ranked_a2a</span>
        <span class="n">coeffs_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">s_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dfranks</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">size</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)]</span>
        <span class="n">r_indices</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="o">+</span> <span class="n">ii</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">s_indices</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">devp</span><span class="o">.</span><span class="n">size</span>
        <span class="k">for</span> <span class="n">s_indx</span><span class="p">,</span> <span class="n">r_indx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">s_indices</span><span class="p">,</span> <span class="n">r_indices</span><span class="p">):</span>
            <span class="c1"># s_indx, r_indx = 0, 1</span>
            <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dfranks</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">s_indx</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;s_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="n">k</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">s_ii</span> <span class="o">=</span> <span class="n">dfranks</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">s_indx</span><span class="p">]</span>
            <span class="n">r_ii</span> <span class="o">=</span> <span class="n">dfranks</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">r_indx</span><span class="p">]</span>
            <span class="n">T_k</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">r_ii</span> <span class="o">-</span> <span class="n">s_ii</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">n</span> <span class="o">+</span> <span class="n">k</span><span class="p">))</span>
            <span class="n">coeffs_list</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span> <span class="n">w</span><span class="p">,</span> <span class="s2">&quot;T_k&quot;</span><span class="p">:</span> <span class="n">T_k</span><span class="p">})</span>
        <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">coeffs_list</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="MackChainLadderResult._spearman_corr_total"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadderResult._spearman_corr_total">[docs]</a>    <span class="k">def</span> <span class="nf">_spearman_corr_total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Weighted average of each adjacent column&#39;s Spearman coefficient</span>
<span class="sd">        from ``self._spearman_corr_coeffs``. Correlation coefficients are weighted</span>
<span class="sd">        by</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Compute w-weighted average of T_k from _spearman_corr_coeffs.</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spearman_corr_coeffs</span><span class="p">()</span>
        <span class="k">return</span><span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;T_k&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span></div>


<div class="viewcode-block" id="MackChainLadderResult._devp_corr_test_var"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadderResult._devp_corr_test_var">[docs]</a>    <span class="k">def</span> <span class="nf">_devp_corr_test_var</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the variance used in the development period correlation test.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        float</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">devp</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">devp</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span></div>


<div class="viewcode-block" id="MackChainLadderResult.devp_corr_test"><a class="viewcode-back" href="../../../trikit.estimators.html#trikit.estimators.mack.MackChainLadderResult.devp_corr_test">[docs]</a>    <span class="k">def</span> <span class="nf">devp_corr_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="o">=.</span><span class="mi">50</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Significance test to assess the degree of development period correlation.</span>
<span class="sd">        The first element of the returned tuple contains the upper and lower</span>
<span class="sd">        bounds of the test interval. The second element represents the test</span>
<span class="sd">        statistic, the weighted average of Spearman rank correlation coefficients.</span>
<span class="sd">        If the test statistic falls within the range bounded by the first element,</span>
<span class="sd">        the null hypothesis of having uncorrelated development factors is not</span>
<span class="sd">        rejected. If the test statistic falls outside the interval, development</span>
<span class="sd">        period correlations should be analyzed in greater detail.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p: float</span>
<span class="sd">            Represents the central normal interval outside of which</span>
<span class="sd">            development factors are assumed to exhibit some degree of</span>
<span class="sd">            correlation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">fnorm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
            <span class="k">return</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">fnorm</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">root</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_devp_corr_test_var</span><span class="p">())</span>
        <span class="k">return</span><span class="p">((</span><span class="o">-</span><span class="n">z</span> <span class="o">/</span> <span class="n">s</span><span class="p">,</span> <span class="n">z</span> <span class="o">/</span> <span class="n">s</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spearman_corr_total</span><span class="p">())</span></div>



<div class="viewcode-block" id="MackChainLadderResult._cy_effects_table"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadderResult._cy_effects_table">[docs]</a>    <span class="k">def</span> <span class="nf">_cy_effects_table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a tabular summary of values used in assessing the presence of</span>
<span class="sd">        significant calendar year influences in the set of age-to-age factors.</span>
<span class="sd">        Resulting DataFrame contains the following columns:</span>

<span class="sd">        - j:</span>
<span class="sd">            The diagonal in question. For a triangle with n periods, j ranges</span>
<span class="sd">            from 2 to n - 1. The most recent diagonal is associated with</span>
<span class="sd">            j = n - 1.</span>

<span class="sd">        - S:</span>
<span class="sd">            Represents the number of small age-to-age factors for a given</span>
<span class="sd">            diagonal. Recall that small age-to-age factors are those less</span>
<span class="sd">            than the median for a given development period.</span>

<span class="sd">        - L:</span>
<span class="sd">            Represents the number of large age-to-age factors for a given</span>
<span class="sd">            diagonal. Recall that large age-to-age factors are those greater</span>
<span class="sd">            than the median for a given development period.</span>

<span class="sd">        - Z:</span>
<span class="sd">            For a given j, :math:`Z = min(S, L)`.</span>

<span class="sd">        - n:</span>
<span class="sd">            For a given j, is defined as :math:`S + L`.</span>

<span class="sd">        - m:</span>
<span class="sd">            For a given j, is defined as :math:`floor([n - 1] / 2)`.</span>

<span class="sd">        - E_Z:</span>
<span class="sd">            For a given j, is defined as :math:`\\frac{n}{2} - \\binom{n-1}{m} \\times \\frac{n}{2^{n}}`.</span>

<span class="sd">        - V_Z:</span>
<span class="sd">            For a given j, is defined as</span>
<span class="sd">            :math:`\\frac{n(n-1)}{4} - \\binom{n-1}{m} \\times \\frac{n(n-1)}{2^{n}} + \\mu - \\mu^{2}`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">summ_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">dflvi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">a2a_lvi</span>
        <span class="n">dfhl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">a2a_assignment</span>
        <span class="n">dflvi</span> <span class="o">=</span> <span class="n">dflvi</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;dev&quot;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">devpinc</span> <span class="o">=</span> <span class="n">dflvi</span><span class="p">[</span><span class="s2">&quot;dev&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">origininc</span> <span class="o">=</span> <span class="n">dflvi</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">diag_indx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">dflvi</span><span class="p">[</span><span class="s2">&quot;dev&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">)),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">dfhl2</span> <span class="o">=</span> <span class="n">dfhl</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;origin&quot;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span>
            <span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;dev&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>

        <span class="c1"># Begin with latest diagonal. Work backwards.</span>
        <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">devp</span> <span class="ow">in</span> <span class="n">diag_indx</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">dcounts</span> <span class="o">=</span> <span class="n">dflvi</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">dfhl2</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">,</span> <span class="s2">&quot;dev&quot;</span><span class="p">])[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
            <span class="n">dsumm</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;j&quot;</span><span class="p">:</span> <span class="n">jj</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">:</span> <span class="n">dcounts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s2">&quot;L&quot;</span><span class="p">:</span> <span class="n">dcounts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)}</span>
            <span class="n">summ_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dsumm</span><span class="p">)</span>
            <span class="c1"># Adjust dflvi by shifting origin period back a single period</span>
            <span class="c1"># relative to devp. Drop record in which origin is missing.</span>
            <span class="n">dflvi</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dflvi</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dflvi</span> <span class="o">=</span> <span class="n">dflvi</span><span class="p">[</span><span class="o">~</span><span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">dflvi</span><span class="o">.</span><span class="n">origin</span><span class="p">)]</span>
            <span class="n">dflvi</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dflvi</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">dfcy</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">summ_list</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;j&quot;</span><span class="p">)</span>

        <span class="c1"># Z is defined as the minimum of S and L by record.</span>
        <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;Z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcy</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rec</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">L</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># n is defined as the sum of S + L by record.</span>
        <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;S&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">]</span>

        <span class="c1"># m is defined as the largest integer &lt;= (n - 1) / 2.</span>
        <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="o">.</span><span class="mi">50</span> <span class="o">*</span> <span class="p">(</span><span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># E_Z is the expected value of Z.</span>
        <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;E_Z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">50</span> <span class="o">*</span> <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">special</span><span class="o">.</span><span class="n">binom</span><span class="p">(</span><span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">*</span> \
            <span class="p">(</span><span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]))</span>

        <span class="c1"># V_Z is the variance of Z.</span>
        <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;V_Z&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">.</span><span class="mi">25</span> <span class="o">*</span> <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> \
            <span class="n">special</span><span class="o">.</span><span class="n">binom</span><span class="p">(</span><span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">*</span> \
            <span class="p">(</span><span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]))</span> <span class="o">+</span> \
            <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;E_Z&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">dfcy</span><span class="p">[</span><span class="s2">&quot;E_Z&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

        <span class="k">return</span><span class="p">(</span><span class="n">dfcy</span><span class="p">)</span></div>


<div class="viewcode-block" id="MackChainLadderResult.cy_effects_test"><a class="viewcode-back" href="../../../trikit.estimators.html#trikit.estimators.mack.MackChainLadderResult.cy_effects_test">[docs]</a>    <span class="k">def</span> <span class="nf">cy_effects_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="o">=.</span><span class="mi">05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        We reject the hypothesis, with an error probability of p, of having no</span>
<span class="sd">        significant calendar year effects only if not::</span>

<span class="sd">            E_Z - 1.96 * sqrt(V_Z)  &lt;=  Z  &lt;=  E_Z + 1.96 * sqrt(V_Z) (if p = .05)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p: float</span>
<span class="sd">            Significance level with which to perform test for calendar year</span>
<span class="sd">            effects. Test is two-sided (see above).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dfcy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cy_effects_table</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">dfcy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">dfcy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;E_Z&quot;</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">dfcy</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;V_Z&quot;</span><span class="p">)</span>
        <span class="n">var_mult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">-</span> <span class="n">var_mult</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">var_mult</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">return</span><span class="p">((</span><span class="n">lb</span><span class="p">,</span> <span class="n">ub</span><span class="p">),</span> <span class="n">Z</span><span class="p">)</span></div>


<div class="viewcode-block" id="MackChainLadderResult._mack_data_transform"><a class="viewcode-back" href="../../../estimators.html#trikit.estimators.mack.MackChainLadderResult._mack_data_transform">[docs]</a>    <span class="k">def</span> <span class="nf">_mack_data_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate data by origin period and in total to plot estimated reserve distributions.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s2">&quot;origin&quot;</span><span class="p">:</span> <span class="n">ii</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="o">.</span><span class="mi">001</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="o">.</span><span class="mi">999</span><span class="p">),</span> <span class="mi">100</span><span class="p">),</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="o">.</span><span class="mi">001</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="o">.</span><span class="mi">999</span><span class="p">),</span> <span class="mi">100</span><span class="p">))</span>
                <span class="p">})</span>
            <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="o">.</span><span class="n">index</span>
            <span class="p">])</span>

        <span class="k">return</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]))</span></div>


<div class="viewcode-block" id="MackChainLadderResult.get_quantiles"><a class="viewcode-back" href="../../../trikit.estimators.html#trikit.estimators.mack.MackChainLadderResult.get_quantiles">[docs]</a>    <span class="k">def</span> <span class="nf">get_quantiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get quantiles of estimated reserve distribution for an individual origin periods and</span>
<span class="sd">        in total. Returns a DataFrame, with columns representing the percentiles of interest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q: array_like of float or float</span>
<span class="sd">            Quantile or sequence of quantiles to compute, which must be between 0 and 1</span>
<span class="sd">            inclusive.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">qarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">qarr</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">qarr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;q values must fall within [0, 1].&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qtls</span><span class="p">,</span> <span class="n">qtlhdrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qtls_formatter</span><span class="p">(</span><span class="n">q</span><span class="o">=</span><span class="n">q</span><span class="p">)</span>
            <span class="n">qtl_pairs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">qtlhdrs</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">qtls</span><span class="p">[</span><span class="n">ii</span><span class="p">])</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qtls</span><span class="p">))]</span>
            <span class="n">dqq</span> <span class="o">=</span> <span class="p">{</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">ii</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">origin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">qtl_pairs</span>
                <span class="p">}</span>
        <span class="k">return</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dqq</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">index</span><span class="p">))</span></div>



<div class="viewcode-block" id="MackChainLadderResult.plot"><a class="viewcode-back" href="../../../trikit.estimators.html#trikit.estimators.mack.MackChainLadderResult.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="o">=.</span><span class="mi">95</span><span class="p">,</span> <span class="n">dist_color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">q_color</span><span class="o">=</span><span class="s2">&quot;#E02C70&quot;</span><span class="p">,</span> <span class="n">axes_style</span><span class="o">=</span><span class="s2">&quot;darkgrid&quot;</span><span class="p">,</span>
             <span class="n">context</span><span class="o">=</span><span class="s2">&quot;notebook&quot;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">exhibit_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot estimated reserve distribution by origin year and in total.</span>
<span class="sd">        The mean of the reserve estimate will be highlighted, along with</span>
<span class="sd">        and quantiles specified in ``q``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        q: float in range of [0,1]</span>
<span class="sd">            The quantile to highlight, which must be between 0 and 1 inclusive.</span>

<span class="sd">        dist_color: str</span>
<span class="sd">            Color or hexidecimal color code of estimated reserve distribution.</span>

<span class="sd">        q_color: str</span>
<span class="sd">            Color or hexidecimal color code of estimated reserve mean</span>
<span class="sd">            and quantiles.</span>

<span class="sd">        axes_style: {&quot;darkgrid&quot;, &quot;whitegrid&quot;, &quot;dark&quot;, &quot;white&quot;, &quot;ticks&quot;}</span>
<span class="sd">            Aesthetic style of seaborn plots. Default values is &quot;darkgrid&quot;.</span>

<span class="sd">        context: {&quot;notebook&quot;, &quot;paper&quot;, &quot;talk&quot;, &quot;poster&quot;}.</span>
<span class="sd">            Set the plotting context parameters. According to the seaborn</span>
<span class="sd">            documentation, This affects things like the size of the labels,</span>
<span class="sd">            lines, and other elements of the plot, but not the overall style.</span>
<span class="sd">            Default value is &quot;notebook&quot;.</span>

<span class="sd">        col_wrap: int</span>
<span class="sd">            The maximum number of origin period axes to have on a single row</span>
<span class="sd">            of the resulting FacetGrid. Defaults to 5.</span>

<span class="sd">        exhibit_path: str</span>
<span class="sd">            Path to which exhibit should be written. If None, exhibit will be</span>
<span class="sd">            rendered via ``plt.show()``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_transform</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">sns</span><span class="o">.</span><span class="n">axes_style</span><span class="p">(</span><span class="n">axes_style</span><span class="p">):</span>
            <span class="n">qtls</span><span class="p">,</span> <span class="n">qtlhdrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_qtls_formatter</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">FacetGrid</span><span class="p">(</span>
                <span class="n">data</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;origin&quot;</span><span class="p">,</span> <span class="n">col_wrap</span><span class="o">=</span><span class="n">col_wrap</span><span class="p">,</span> <span class="n">margin_titles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">despine</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>

            <span class="n">grid</span><span class="o">.</span><span class="n">set_axis_labels</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">dist_color</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.25</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">origin</span><span class="p">,</span> <span class="n">ax_ii</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">grid</span><span class="o">.</span><span class="n">axes</span><span class="p">):</span>
                <span class="c1"># Determine reserve estimate at mean and specified quantiles.</span>
                <span class="n">rv_ii</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="p">[</span><span class="n">origin</span><span class="p">]</span>
                <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">):</span>
                    <span class="n">qq_ii</span> <span class="o">=</span> <span class="p">[</span><span class="n">rv_ii</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span> <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">qtls</span><span class="p">]</span>
                <span class="n">vline_pos</span><span class="p">,</span> <span class="n">vline_str</span> <span class="o">=</span> <span class="p">[</span><span class="n">rv_ii</span><span class="o">.</span><span class="n">mean</span><span class="p">()]</span> <span class="o">+</span> <span class="n">qq_ii</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">qtlhdrs</span>

                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">vline_pos</span><span class="p">,</span> <span class="n">vline_str</span><span class="p">):</span>
                    <span class="c1"># Draw vertical line and annotation.</span>
                    <span class="n">ax_ii</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">ii</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">q_color</span>
                        <span class="p">)</span>
                    <span class="n">ax_ii</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> = </span><span class="si">{:,.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">jj</span><span class="p">,</span> <span class="n">ii</span><span class="p">),</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">ax_ii</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                        <span class="n">origin</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">85</span><span class="p">,</span> <span class="o">.</span><span class="mi">925</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">.</span><span class="mi">85</span><span class="p">,</span> <span class="o">.</span><span class="mi">925</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span>
                        <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;axes fraction&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">9</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="n">ax_ii</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
                    <span class="n">ax_ii</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
                    <span class="n">ax_ii</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">ax_ii</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">ax_ii</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="n">ax_ii</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

                <span class="c1"># Draw border around each facet.</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax_ii</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">spine</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">visible</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=.</span><span class="mi">50</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">exhibit_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">exhibit_path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="MackChainLadderResult.diagnostics"><a class="viewcode-back" href="../../../trikit.estimators.html#trikit.estimators.mack.MackChainLadderResult.diagnostics">[docs]</a>    <span class="k">def</span> <span class="nf">diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Statistical diagnostics plots of Mack Chain Ladder estimator.</span>
<span class="sd">        Exhibit is a faceted quad plot, representing the estimated</span>
<span class="sd">        reserve distribution, the path to ultimate for each origin period,</span>
<span class="sd">        and residuals by origin and development period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>

        <span class="n">pltkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">pltkwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">dfdens_all</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mack_data_transform</span><span class="p">()</span>
        <span class="n">dfdens</span> <span class="o">=</span> <span class="n">dfdens_all</span><span class="p">[(</span><span class="n">dfdens_all</span><span class="o">.</span><span class="n">origin</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">)]</span>
        <span class="n">dfresid0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_residuals_by_devp</span><span class="p">()</span>
        <span class="n">dfresid1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_residuals_by_origin</span><span class="p">()</span>
        <span class="n">cl_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trisqrd</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;dev&quot;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
            <span class="n">drop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="s2">&quot;origin&quot;</span><span class="p">},</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">grps</span> <span class="o">=</span> <span class="n">cl_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">grps</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">origins</span><span class="p">]</span>

        <span class="c1"># Get unique hex color for each unique origin period.</span>
        <span class="n">fcolors</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">pltkwargs</span><span class="p">[</span><span class="s2">&quot;cmap&quot;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">origins</span><span class="p">))</span>
        <span class="n">colors_rgba</span> <span class="o">=</span> <span class="p">[</span><span class="n">fcolors</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tri</span><span class="o">.</span><span class="n">origins</span><span class="p">))]</span>
        <span class="n">colors_hex</span> <span class="o">=</span> <span class="p">[</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_hex</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span> <span class="n">keep_alpha</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="n">colors_rgba</span><span class="p">]</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">pltkwargs</span><span class="p">[</span><span class="s2">&quot;figsize&quot;</span><span class="p">],</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Upper left facet represents aggregate reserve distribution.</span>
        <span class="n">mean_agg_reserve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="s2">&quot;reserve&quot;</span><span class="p">]</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Aggregate Reserve Distribution&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dfdens</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dfdens</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">mean_agg_reserve</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="s2">&quot;,&quot;</span><span class="p">)))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="s2">&quot;mean total reserve = </span><span class="si">{:,.0f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean_agg_reserve</span><span class="p">),</span>
            <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">mean_agg_reserve</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rvs</span><span class="o">.</span><span class="n">total</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">mean_agg_reserve</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">50</span><span class="p">),</span>
            <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s2">&quot;offset points&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>


        <span class="c1"># Upper right facet represents Chain Ladder development paths (trisqrd).</span>
        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">hex_color</span><span class="p">,</span> <span class="n">dforg</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">colors_hex</span><span class="p">)),</span> <span class="n">colors_hex</span><span class="p">,</span> <span class="n">data_list</span><span class="p">):</span>
            <span class="n">xx</span> <span class="o">=</span> <span class="n">dforg</span><span class="p">[</span><span class="s2">&quot;devp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">yy</span> <span class="o">=</span> <span class="n">dforg</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">marker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_markers</span><span class="p">[</span><span class="n">ii</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_markers</span><span class="p">)]</span>
            <span class="n">yy_divisor</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 1000 if np.all(yy&gt;1000) else 1</span>
            <span class="n">yy_axis_label</span> <span class="o">=</span> <span class="s2">&quot;(000&#39;s)&quot;</span> <span class="k">if</span> <span class="n">yy_divisor</span> <span class="o">==</span> <span class="mi">1000</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">/</span> <span class="n">yy_divisor</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">hex_color</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="n">pltkwargs</span><span class="p">[</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">pltkwargs</span><span class="p">[</span><span class="s2">&quot;linestyle&quot;</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="n">dforg</span><span class="o">.</span><span class="n">origin</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="n">pltkwargs</span><span class="p">[</span><span class="s2">&quot;markersize&quot;</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Development by Origin&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mpl</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="s2">&quot;,&quot;</span><span class="p">)))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;dev&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">yy_axis_label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">cl_data</span><span class="p">[</span><span class="s2">&quot;devp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">cl_data</span><span class="p">[</span><span class="s2">&quot;devp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower right&quot;</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="s2">&quot;x-small&quot;</span><span class="p">)</span>


        <span class="c1"># Lower left facet represents residuals by development period.</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;std. residuals by devp&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">dfresid0</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dfresid0</span><span class="p">[</span><span class="s2">&quot;std_residuals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=.</span><span class="mi">75</span>
            <span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;dev&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;std. residuals&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dfresid0</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># Lower right facet represents residuals by origin period.</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;std. residuals by origin&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="n">dfresid1</span><span class="p">[</span><span class="s2">&quot;t&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dfresid1</span><span class="p">[</span><span class="s2">&quot;std_residuals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;#000000&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#FFFFFF&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
            <span class="n">linewidths</span><span class="o">=.</span><span class="mi">75</span>
            <span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">1.</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;origin&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;std. residuals&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">dfresid1</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2018, James D. Triveri

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>